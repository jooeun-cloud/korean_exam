import streamlit as st
import pandas as pd
from datetime import datetime
import gspread
from oauth2client.service_account import ServiceAccountCredentials

# --- [ì¶”ê°€] ì„±ì í‘œ HTML ìƒì„± í•¨ìˆ˜ ---
def create_report_html(name, score, rank, total_students, wrong_q_nums, wrong_list, feedback_text):
    now = datetime.now().strftime("%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„")
    
    if wrong_q_nums:
        wrong_nums_str = ", ".join(wrong_q_nums) + "ë²ˆ"
    else:
        wrong_nums_str = "ì—†ìŒ (ë§Œì )"

    html = f"""
    <html>
    <head>
        <style>
            body {{ font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; padding: 40px; background-color: #f0f0f0; }}
            .paper {{ background-color: white; padding: 50px; max-width: 800px; margin: 0 auto; border: 1px solid #ccc; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); }}
            h1 {{ text-align: center; color: #333; border-bottom: 2px solid #333; padding-bottom: 20px; }}
            .info-table {{ width: 100%; border-collapse: collapse; margin-bottom: 30px; }}
            .info-table th {{ background-color: #eee; padding: 10px; border: 1px solid #ddd; width: 30%; }}
            .info-table td {{ padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; }}
            .score-box {{ text-align: center; padding: 20px; background-color: #f9f9f9; border-radius: 10px; margin: 20px 0; }}
            .score {{ font-size: 40px; color: #d32f2f; font-weight: bold; }}
            .feedback-section {{ margin-top: 30px; line-height: 1.6; }}
            .feedback-box {{ background-color: #fff8e1; padding: 15px; border-left: 5px solid #ffb300; margin-bottom: 15px; }}
            .footer {{ margin-top: 50px; text-align: center; color: #888; font-size: 12px; }}
        </style>
    </head>
    <body>
        <div class="paper">
            <h1>ğŸ“‘ êµ­ì–´ ëª¨ì˜ê³ ì‚¬ ë¶„ì„ ì„±ì í‘œ</h1>
            
            <table class="info-table">
                <tr>
                    <th>ì´ë¦„</th>
                    <td>{name}</td>
                    <th>ì‘ì‹œì¼ì</th>
                    <td>{now}</td>
                </tr>
                <tr>
                    <th>ë‚´ ì ìˆ˜</th>
                    <td style="color: blue;">{int(score)}ì </td>
                    <th>ì „ì²´ ë“±ìˆ˜</th>
                    <td>{rank}ë“± / {total_students}ëª…</td>
                </tr>
            </table>

            <div class="score-box">
                <div>í‹€ë¦° ë¬¸ì œ ë²ˆí˜¸</div>
                <div style="font-size: 18px; margin-top: 5px;">âŒ {wrong_nums_str}</div>
            </div>

            <div class="feedback-section">
                <h2>ğŸ’Š ìœ í˜•ë³„ ìƒì„¸ ì²˜ë°©</h2>
                {feedback_text}
            </div>

            <div class="footer">
                ìœ„ í•™ìƒì˜ ëª¨ì˜ê³ ì‚¬ ê²°ê³¼ë¥¼ ì¦ëª…í•©ë‹ˆë‹¤.<br>
                Designed by AI Teacher
            </div>
        </div>
    </body>
    </html>
    """
    return html

# --- 1. êµ¬ê¸€ ì‹œíŠ¸ ì¸ì¦ ë° ì—°ê²° ì„¤ì • ---
def get_google_sheet_data():
    if "gcp_service_account" not in st.secrets:
        st.error("ë¹„ë°€ í‚¤(Secrets)ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return None

    scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
    creds = ServiceAccountCredentials.from_json_keyfile_dict(dict(st.secrets["gcp_service_account"]), scope)
    client = gspread.authorize(creds)
    
    try:
        sheet = client.open("ExamResults").sheet1
        return sheet
    except gspread.SpreadsheetNotFound:
        st.error("êµ¬ê¸€ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ ì´ë¦„ì„ 'ExamResults'ë¡œ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
        return None

# --- 2. ë¬¸ì œ ë°ì´í„° ë° ì •ë‹µ ì„¤ì • ---
EXAM_DATA = {
    1: {"ans": 2, "score": 3, "type": "ê°•ì—°ìì˜ ë§í•˜ê¸° ë°©ì‹ ì´í•´"},
    2: {"ans": 4, "score": 3, "type": "ê°•ì—° ìë£Œì˜ ì ì ˆì„± íŒë‹¨"},
    3: {"ans": 2, "score": 3, "type": "<ë³´ê¸°>ë¥¼ ë³´ê³  ì²­ìì˜ ë“£ê¸° ì „ëµ ì´í•´"},
    4: {"ans": 5, "score": 3, "type": "ìŒìš´ ë™í™” ì´í•´"},
    5: {"ans": 1, "score": 3, "type": "ìŒìš´ ë™í™”ì˜ êµ¬ì²´ì  ì‚¬ë¡€ ì´í•´"},
    6: {"ans": 1, "score": 4, "type": "ë¬¸ì¥ì˜ ì§œì„ ì´í•´ (ë¬¸ë²•)"},
    7: {"ans": 5, "score": 3, "type": "êµ­ì–´ì‚¬ì „ì˜ ì •ë³´ íƒêµ¬"},
    8: {"ans": 1, "score": 3, "type": "ì¤‘ì„¸êµ­ì–´ì˜ íŠ¹ì§• íƒêµ¬"},
    9: {"ans": 2, "score": 3, "type": "ì² í•™ ë¹„ë¬¸í•™ ì§€ë¬¸ ë‚´ìš© ì´í•´"},
    10: {"ans": 5, "score": 3, "type": "ì² í•™ ë¹„ë¬¸í•™ ì§€ë¬¸ ì„¸ë¶€ ë‚´ìš© ì´í•´"},
    11: {"ans": 2, "score": 3, "type": "ì² í•™ ë¹„ë¬¸í•™ í•µì‹¬ë‚´ìš© <ë³´ê¸°> ì ìš©"},
    12: {"ans": 2, "score": 4, "type": "ì² í•™ ë¹„ë¬¸í•™ ë°”íƒ•ìœ¼ë¡œ <ë³´ê¸°> ìë£Œ í•´ì„"},
    13: {"ans": 5, "score": 3, "type": "í•œêµ­ì˜ ì „í†µì‹œê°€/í•œêµ­ë¬¸í•™ íŠ¹ì§• ì´í•´"},
    14: {"ans": 1, "score": 3, "type": "ì‘í’ˆì˜ í‘œí˜„ìƒì˜ íŠ¹ì§• íŒŒì•…"},
    15: {"ans": 3, "score": 3, "type": "ì‹œì–´ì˜ ì˜ë¯¸ íŒŒì•…"},
    16: {"ans": 5, "score": 3, "type": "ì‘í’ˆì˜ ì‹œìƒ ì „ê°œ ê³¼ì • íŒŒì•…"},
    17: {"ans": 4, "score": 4, "type": "ì™¸ì  ì¤€ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘í’ˆ ê°ìƒ"},
    18: {"ans": 2, "score": 3, "type": "ê²½ì œ ë¹„ë¬¸í•™ ì§€ë¬¸ ë‚´ìš© ì „ê°œ ë°©ì‹"},
    19: {"ans": 3, "score": 3, "type": "ê²½ì œ ë¹„ë¬¸í•™ ì§€ë¬¸ ì„¸ë¶€ ì •ë³´ ì´í•´"},
    20: {"ans": 2, "score": 4, "type": "ê²½ì œ ë¹„ë¬¸í•™ ë‚´ìš© êµ¬ì²´ì  ìƒí™© ì ìš©"},
    21: {"ans": 3, "score": 3, "type": "ê°ë³¸ì„ ì½ê³  ì—°ì¶œ ê³„íš ì ì ˆì„± í‰ê°€"},
    22: {"ans": 4, "score": 4, "type": "ê°ë³¸ì„ ì™¸ì  ì¤€ê±°ì— ë”°ë¼ ê°ìƒ"},
    23: {"ans": 1, "score": 3, "type": "ê°ë³¸ ì‘í’ˆ ë§¥ë½ íŒŒì•… ë° êµ¬ì ˆ ì˜ë¯¸"},
    24: {"ans": 1, "score": 3, "type": "ê±´ì¶• ë¹„ë¬¸í•™ ê¸€ì˜ ì„¸ë¶€ ì •ë³´ íŒŒì•…"},
    25: {"ans": 4, "score": 3, "type": "ê±´ì¶• ë¹„ë¬¸í•™ ê¸€ì˜ í•µì‹¬ ì •ë³´ íŒŒì•…"},
    26: {"ans": 3, "score": 3, "type": "ë¹„ë¬¸í•™ ì„¸ë¶€ ë‚´ìš© ê³µí†µì  ì¶”ë¡ "},
    27: {"ans": 3, "score": 4, "type": "ê±´ì¶• ë¹„ë¬¸í•™ ë‚´ìš© êµ¬ì²´ì  ì‚¬ë¡€ ì ìš©"},
    28: {"ans": 5, "score": 4, "type": "ì†Œì„¤ì˜ ì„œì‚¬ì  íŠ¹ì§• ì´í•´"},
    29: {"ans": 3, "score": 3, "type": "ì†Œì„¤ì˜ ì¬ë‹´ êµ¬ì¡° ì´í•´"},
    30: {"ans": 4, "score": 3, "type": "ì†Œì„¤ì„ ì½ê³  ì¸ë¬¼ì˜ ì‹¬ë¦¬ ì´í•´"},
    31: {"ans": 1, "score": 3, "type": "ìƒí™©ì— ë§ëŠ” í•œìì„±ì–´ ì´í•´"},
}

# --- 3. í”¼ë“œë°± ë° ì¹­ì°¬ ë©”ì‹œì§€ í•¨ìˆ˜ ---
def get_feedback_message(question_type):
    # =================================================================
    # [1] ë¬¸ë²• (ìŒìš´, í†µì‚¬, êµ­ì–´ì‚¬)
    # =================================================================
    if "ìŒìš´" in question_type:
        return """
### ğŸ›‘ [ê¸´ê¸‰ ì²˜ë°©] ë¬¸ë²•: 'ìŒìš´ ë³€ë™'ì˜ ì›ë¦¬ë¥¼ ë†“ì¹˜ê³  ìˆìŠµë‹ˆë‹¤.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ë‹¨ìˆœíˆ ë‹¨ì–´ë¥¼ ë°œìŒí•´ë³´ê³  ê°ìœ¼ë¡œ ë‹µì„ ì°¾ìœ¼ë ¤ í–ˆê±°ë‚˜, 'êµì²´, íƒˆë½, ì²¨ê°€, ì¶•ì•½'ì˜ ê°œë…ì´ ë¨¸ë¦¿ì†ì—ì„œ ë’¤ì„ì—¬ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ìŒìš´ ë³€ë™ì€ ë°œìŒ ìŠµê´€ì´ ì•„ë‹ˆë¼ **ì—„ê²©í•œ ìŒìš´ í™˜ê²½ì˜ ë²•ì¹™**ì…ë‹ˆë‹¤.

**2. í•µì‹¬ ê°œë… ì •ë¦¬ (ì´ê²ƒë§Œì€ ê¼­!)**
* **êµì²´:** ë¹„ìŒí™”, ìœ ìŒí™”, êµ¬ê°œìŒí™”, ëœì†Œë¦¬ë˜ê¸°, ìŒì ˆì˜ ëì†Œë¦¬ ê·œì¹™ (ê°œìˆ˜ ë³€í™” ì—†ìŒ)
* **íƒˆë½:** ììŒêµ° ë‹¨ìˆœí™”, ã„¹íƒˆë½, ã…íƒˆë½, ìœ¼íƒˆë½ (ì˜ë¬¸ ê°œìˆ˜ -1)
* **ì²¨ê°€:** ã„´ì²¨ê°€ (ì˜ë¬¸ ê°œìˆ˜ +1)
* **ì¶•ì•½:** ê±°ì„¼ì†Œë¦¬ë˜ê¸° (ììŒ ì¶•ì•½) (ì˜ë¬¸ ê°œìˆ˜ -1)

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **ë°±ì§€ ë³µìŠµ:** êµê³¼ì„œë¥¼ ë®ê³  ìœ„ 4ê°€ì§€ ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ëŠ” ì„¸ë¶€ ê·œì¹™ë“¤ì„ ì•ˆ ë³´ê³  ì ì„ ìˆ˜ ìˆëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”. ëª» ì ìœ¼ë©´ ëª¨ë¥´ëŠ” ê²ƒì…ë‹ˆë‹¤.
2.  **í™˜ê²½ ë¶„ì„:** íŠ¹íˆ 'ë¹„ìŒí™”'ê°€ ì¼ì–´ë‚˜ëŠ” ì¡°ê±´(íŒŒì—´ìŒ ë’¤ì— ë¹„ìŒì´ ì˜¬ ë•Œ ë“±)ì„ ì˜ˆì‹œ ë‹¨ì–´ 3ê°œì™€ í•¨ê»˜ ì •ë¦¬í•˜ì„¸ìš”.
3.  **ë„ì‹í™” í›ˆë ¨:** í‹€ë¦° ë‹¨ì–´ë¥¼ ë†“ê³  `êµ­ë¬¼ -> [ê¶ë¬¼] (ã„±->ã…‡, ë¹„ìŒí™”, êµì²´)` ì²˜ëŸ¼ **[ë³€í™” ì–‘ìƒ / ê·œì¹™ ì´ë¦„ / ë³€ë™ ìœ í˜•]** 3ë‹¨ê³„ë¥¼ ì ëŠ” ì—°ìŠµì„ í•˜ì„¸ìš”.
"""

    elif "ë¬¸ì¥" in question_type or "ë¬¸ë²•" in question_type:
        return """
### ğŸ—ï¸ [ì‹¬ì¸µ ë¶„ì„] ë¬¸ë²•: ë¬¸ì¥ì˜ 'ë¼ˆëŒ€'ë¥¼ ë³´ëŠ” ëˆˆì´ í•„ìš”í•©ë‹ˆë‹¤.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ë¬¸ì¥ì´ ì¡°ê¸ˆë§Œ ê¸¸ì–´ì§€ê±°ë‚˜ ê´€í˜•ì ˆì´ ìˆ¨ì–´ìˆìœ¼ë©´ ì„±ë¶„ì„ ì°¾ì§€ ëª»í•˜ê³  í—¤ë§¤ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. 'ì–´ë¯¸'ì™€ 'ì¡°ì‚¬'ë¥¼ ë³´ëŠ” ëˆˆì´ ì˜ˆë¯¼í•˜ì§€ ëª»í•´ì„œ ë¬¸ì¥ì´ ì–´ë””ì„œ ëŠì–´ì§€ëŠ”ì§€ íŒŒì•…í•˜ì§€ ëª»í•œ ê²ƒì…ë‹ˆë‹¤.

**2. í•µì‹¬ ê°œë… ì •ë¦¬**
* **ì•ˆê¸´ë¬¸ì¥ ì°¾ê¸°:** ë¬¸ì¥ ì¤‘ê°„ì— `-(ìœ¼)ã„´/ëŠ”`(ê´€í˜•ì‚¬í˜• ì–´ë¯¸), `-(ìœ¼)ã…/ê¸°`(ëª…ì‚¬í˜• ì–´ë¯¸), `-ê²Œ/ë„ë¡`(ë¶€ì‚¬í˜• ì–´ë¯¸)ì´ ë³´ì´ë©´ ë¬´ì¡°ê±´ ë„¤ëª¨ ë°•ìŠ¤ë¥¼ ì¹˜ì„¸ìš”. ê·¸ê²Œ ë°”ë¡œ ì•ˆê¸´ë¬¸ì¥ì…ë‹ˆë‹¤.
* **ì„œìˆ ì–´ ìë¦¿ìˆ˜:** ì„œìˆ ì–´(ë™ì‚¬/í˜•ìš©ì‚¬)ê°€ ì˜¨ì „í•œ ë¬¸ì¥ì´ ë˜ê¸° ìœ„í•´ ì£¼ì–´ ì™¸ì— ëª©ì ì–´ë‚˜ ë¶€ì‚¬ì–´ê°€ ê¼­ í•„ìš”í•œì§€ íŒë‹¨í•´ì•¼ í•©ë‹ˆë‹¤.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **ê¼¬ë¦¬ ì°¾ê¸°:** ì˜¤ëŠ˜ í‹€ë¦° ì§€ë¬¸ì˜ ëª¨ë“  ë¬¸ì¥ì—ì„œ **ì„œìˆ ì–´**ì— ë¨¼ì € ë°‘ì¤„ì„ ê·¸ìœ¼ì„¸ìš”.
2.  **ì§ ì§“ê¸°:** ê·¸ ì„œìˆ ì–´ì˜ ì£¼ì–´ê°€ ë¬´ì—‡ì¸ì§€ í™”ì‚´í‘œë¡œ ì—°ê²°í•˜ì„¸ìš”. (ì£¼ì–´ê°€ ìƒëµë˜ì—ˆë‹¤ë©´ ê´„í˜¸ ì¹˜ê³  ì±„ì›Œ ë„£ìœ¼ì„¸ìš”.)
3.  **ì„±ë¶„ ë¶„ì„:** ë¬¸ì¥ ì„±ë¶„ì„ ë¬»ëŠ” ë¬¸ì œì˜€ë‹¤ë©´, `ì´/ê°€(ì£¼ì–´)`, `ì„/ë¥¼(ëª©ì ì–´)`, `ì—/ì—ê²Œ/ë¡œ(ë¶€ì‚¬ì–´)` ë“± ê²©ì¡°ì‚¬ì— ë™ê·¸ë¼ë¯¸ ì¹˜ë©° ì„±ë¶„ì„ êµ¬ë³„í•˜ì„¸ìš”.
"""

    elif "ì¤‘ì„¸" in question_type or "êµ­ì–´ì‚¬ì „" in question_type:
        return """
### ğŸ“œ [ì‹¬ì¸µ ë¶„ì„] ë¬¸ë²•: ì¤‘ì„¸ êµ­ì–´ëŠ” 'ë‹¤ë¥¸ ê·¸ë¦¼ ì°¾ê¸°'ì…ë‹ˆë‹¤.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ì¤‘ì„¸ êµ­ì–´ í‘œê¸°ê°€ ë‚¯ì„¤ì–´ì„œ ê²ì„ ë¨¹ì—ˆì„ í™•ë¥ ì´ í½ë‹ˆë‹¤. í•˜ì§€ë§Œ ìˆ˜ëŠ¥ êµ­ì–´ì—ì„œ ì¤‘ì„¸ êµ­ì–´ëŠ” ê³ ë¬¸ í•´ë… ëŠ¥ë ¥ì„ ë¬»ëŠ” ê²Œ ì•„ë‹ˆë¼, **í˜„ëŒ€ì–´ í’€ì´ì™€ ë¹„êµí•˜ì—¬ ë¬¸ë²•ì ì¸ ì°¨ì´ë¥¼ ë°œê²¬í•˜ëŠ” ëŠ¥ë ¥**ì„ ë¬»ìŠµë‹ˆë‹¤.

**2. í•µì‹¬ ê°œë… ì •ë¦¬**
* **ì¡°ì‚¬ì˜ ì°¨ì´:** ì£¼ê²©ì¡°ì‚¬ `ì´` ì™¸ì— ëª¨ìŒ ë’¤ì— ì“°ì¸ `ã…£`, ìƒëµë˜ëŠ” ê²½ìš°ë¥¼ êµ¬ë¶„í•´ì•¼ í•©ë‹ˆë‹¤. ê´€í˜•ê²© ì¡°ì‚¬ `ã……`ì˜ ì“°ì„ë„ ë‹¨ê³¨ ë¬¸ì œì…ë‹ˆë‹¤.
* **ê°ì²´ ë†’ì„:** `ì‚½, ì¡, ì••` ê°™ì€ ì„ ì–´ë§ ì–´ë¯¸ê°€ ëˆ„êµ¬ë¥¼ ë†’ì´ëŠ”ì§€(ëª©ì ì–´, ë¶€ì‚¬ì–´) ë°˜ë“œì‹œ í˜„ëŒ€ì–´ í’€ì´ì™€ ëŒ€ì¡°í•´ì•¼ í•©ë‹ˆë‹¤.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **ì¼ëŒ€ì¼ ëŒ€ì‘:** ë¬¸ì œì— ë‚˜ì˜¨ <ë³´ê¸°> ì§€ë¬¸(ì¤‘ì„¸ì–´) ë°”ë¡œ ë°‘ì— í˜„ëŒ€ì–´ í’€ì´ë¥¼ í•œ ë‹¨ì–´ì”© ì§ì§€ì–´ ì ì–´ë³´ì„¸ìš”.
2.  **ì°¨ì´ì  ë°œê²¬:** í˜•íƒœê°€ ë‹¤ë¥¸ ë¶€ë¶„(ì˜ˆ: 'ë°±ì…©ì´' vs 'ë°±ì„±ì´')ì„ ì°¾ê³ , ì™œ ë‹¬ë¼ì¡ŒëŠ”ì§€(ì´ì–´ì ê¸° vs ëŠì–´ì ê¸°) ë¬¸ë²• ìš©ì–´ë¡œ ì„¤ëª…í•´ë³´ì„¸ìš”.
3.  **ê°œë…ì–´ ì•”ê¸°:** ì´ì–´ì ê¸°, ëŠì–´ì ê¸°, ê±°ë“­ì ê¸°, 8ì¢…ì„±ë²• ë“± ê¸°ì´ˆ ìš©ì–´ 10ê°œë¥¼ ë…¸íŠ¸ì— ì •ë¦¬í•˜ê³  ì•”ê¸°í•˜ì„¸ìš”.
"""

    # =================================================================
    # [2] ë¹„ë¬¸í•™ (ì² í•™, ê²½ì œ, ê¸°ìˆ /ê³¼í•™)
    # =================================================================
    elif "ì² í•™" in question_type or "ì¸ë¬¸" in question_type:
        return """
### ğŸ§  [ì‹¬ì¸µ ë¶„ì„] ë¹„ë¬¸í•™(ì¸ë¬¸): í•™ìë“¤ì˜ 'ë§ì‹¸ì›€'ì„ ì •ë¦¬í•˜ì„¸ìš”.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ê¸€ì„ ì½ê¸´ ì½ì—ˆëŠ”ë° ë¨¸ë¦¿ì†ì— ë‚¨ëŠ” ê²Œ ì—†ë‹¤ë©´, ì •ë³´ê°€ **êµ¬ì¡°í™”**ë˜ì§€ ì•Šê³  ë‘¥ë‘¥ ë– ë‹¤ë‹ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. íŠ¹íˆ ì² í•™ ì§€ë¬¸ì€ Aí•™ìì™€ Bí•™ìê°€ ì„œë¡œ ë‹¤ë¥¸ ì£¼ì¥ì„ í•˜ê±°ë‚˜, ì‹œëŒ€ê°€ íë¥´ë©° ì‚¬ìƒì´ ë³€í•˜ëŠ” ê³¼ì •ì„ ë†“ì¹˜ë©´ ë¬¸ì œë¥¼ í’€ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

**2. ë…í•´ ì „ëµ (Reading Strategy)**
* **ì´í•­ ëŒ€ë¦½:** ì§€ë¬¸ì— ë‘ ê°€ì§€ ê´€ì ì´ ë‚˜ì˜¤ë©´ ë¬´ì¡°ê±´ `A vs B` êµ¬ë„ë¡œ ë‚˜ëˆ„ì–´ ì½ìœ¼ì„¸ìš”.
* **ì°¨ì´ì  ì£¼ëª©:** ë‘ í•™ìê°€ ë™ì˜í•˜ëŠ” ë¶€ë¶„(ê³µí†µ ì „ì œ)ê³¼, ê²°ì •ì ìœ¼ë¡œ ê°ˆë¼ì§€ëŠ” ë¶€ë¶„(ì°¨ì´ì )ì´ ë¬¸ì œì˜ ì •ë‹µì´ ë©ë‹ˆë‹¤.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **í‘œ ê·¸ë¦¬ê¸°:** ì§€ë¬¸ì„ ë‹¤ ì½ê³  ë‚˜ì„œ ë¹ˆ ì¢…ì´ì— Aí•™ìì™€ Bí•™ìì˜ ì´ë¦„ì„ ì ê³ , ê·¸ë“¤ì˜ í•µì‹¬ í‚¤ì›Œë“œ(ì£¼ì¥, ê·¼ê±°, í•œê³„)ë¥¼ í‘œë¡œ ì •ë¦¬í•˜ì„¸ìš”.
2.  **ì ‘ì†ì‚¬ ì²´í¬:** 'ê·¸ëŸ¬ë‚˜', 'ë°˜ë©´', 'ì˜¤íˆë ¤' ê°™ì€ ì—­ì ‘ ì ‘ì†ì‚¬ì— ì„¸ëª¨ í‘œì‹œë¥¼ í•˜ì„¸ìš”. ê·¸ ë’¤ì— ì§„ì§œ ì¤‘ìš”í•œ ì •ë³´ê°€ ë‚˜ì˜µë‹ˆë‹¤.
3.  **ë‹¨ì •ì  í‘œí˜„ ì£¼ì˜:** ì„ ì§€ì—ì„œ 'ë°˜ë“œì‹œ', 'ëª¨ë“ ', 'ìœ ì¼í•œ' ê°™ì€ í‘œí˜„ì´ ë‚˜ì˜¤ë©´, ì§€ë¬¸ì—ì„œ ì˜ˆì™¸ê°€ ì—†ì—ˆëŠ”ì§€ ì˜ì‹¬ì˜ ëˆˆì´ˆë¦¬ë¡œ í™•ì¸í•˜ì„¸ìš”.
"""

    elif "ê²½ì œ" in question_type or "ì‚¬íšŒ" in question_type:
        return """
### ğŸ“ˆ [ì‹¬ì¸µ ë¶„ì„] ë¹„ë¬¸í•™(ê²½ì œ): 'ì¸ê³¼ ê´€ê³„'ì˜ í™”ì‚´í‘œë¥¼ ê·¸ë¦¬ì„¸ìš”.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ê²½ì œ ì§€ë¬¸ì€ í…ìŠ¤íŠ¸ë¡œ ëœ **ìˆ˜í•™ ë¬¸ì œ**ì…ë‹ˆë‹¤. í™˜ìœ¨ì´ ì˜¤ë¥´ë©´ ìˆ˜ì¶œì´ ì–´ë–»ê²Œ ë˜ê³ , ê¸ˆë¦¬ê°€ ë‚´ë¦¬ë©´ íˆ¬ìê°€ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ ê·¸ **ë©”ì»¤ë‹ˆì¦˜(ê³¼ì •)**ì„ ì´í•´í•˜ì§€ ëª»í•˜ê³  ê¸€ìë§Œ ì½ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

**2. ë…í•´ ì „ëµ (Reading Strategy)**
* **ë¹„ë¡€/ë°˜ë¹„ë¡€ í‘œì‹œ:** ì§€ë¬¸ì„ ì½ì„ ë•Œ `ê¸ˆë¦¬(â†‘) -> í†µí™”ëŸ‰(â†“)` ì²˜ëŸ¼ ë³€ìˆ˜ ì˜†ì— í™”ì‚´í‘œë¥¼ ë°˜ë“œì‹œ í‘œì‹œí•˜ì„¸ìš”.
* **ìˆ˜ì‹ì˜ ì´í•´:** `A = B / C` ê°™ì€ ìˆ˜ì‹ ê´€ê³„ê°€ ë‚˜ì˜¤ë©´, Cê°€ ì»¤ì§€ë©´ AëŠ” ì‘ì•„ì§„ë‹¤ëŠ” ë°˜ë¹„ë¡€ ê´€ê³„ë¥¼ ë¨¸ë¦¿ì†ì— ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **ê´€ê³„ë„ ê·¸ë¦¬ê¸°:** ì˜¤ë‹µ ë…¸íŠ¸ì— ì§€ë¬¸ì— ë‚˜ì˜¨ ê²½ì œ í˜„ìƒì˜ ì¸ê³¼ ê´€ê³„ë¥¼ í™”ì‚´í‘œ ë„ì‹ìœ¼ë¡œ ê·¸ë ¤ë³´ì„¸ìš”. (ì›ì¸ -> ê²°ê³¼1 -> ê²°ê³¼2)
2.  **ê·¸ë˜í”„ í•´ì„:** ì§€ë¬¸ì— ê·¸ë˜í”„ê°€ ìˆë‹¤ë©´ Xì¶•(ê°€ë¡œ)ê³¼ Yì¶•(ì„¸ë¡œ)ì´ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€, ê³¡ì„ ì´ ìš°ìƒí–¥í•˜ëŠ”ì§€ ìš°í•˜í–¥í•˜ëŠ”ì§€ ë¨¼ì € íŒŒì•…í•˜ê³  ì§€ë¬¸ì„ ì½ìœ¼ì„¸ìš”.
3.  **ê°€ìƒ ëŒ€ì…:** <ë³´ê¸°> ë¬¸ì œì— êµ¬ì²´ì ì¸ ìƒí™©(ì˜ˆ: Aêµ­ê°€ì˜ í™˜ìœ¨ í­ë“±)ì´ ë‚˜ì˜¤ë©´, ì§€ë¬¸ì—ì„œ ì •ë¦¬í•œ í™”ì‚´í‘œ ê³µì‹ì— ê·¸ëŒ€ë¡œ ëŒ€ì…í•´ì„œ ê²°ê³¼ë¥¼ ì˜ˆì¸¡í•˜ì„¸ìš”.
"""

    elif "ê±´ì¶•" in question_type or "ê¸°ìˆ " in question_type or "ê³¼í•™" in question_type:
        return """
### âš™ï¸ [ì‹¬ì¸µ ë¶„ì„] ë¹„ë¬¸í•™(ê¸°ìˆ /ê³¼í•™): 'ì‘ë™ ì›ë¦¬'ë¥¼ ì‹œê°í™”í•˜ì„¸ìš”.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ê¸°ìˆ  ì§€ë¬¸ì€ ì–´ë–¤ ì¥ì¹˜ì˜ **êµ¬ì¡°**ì™€ **ì‘ë™ ìˆœì„œ**ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤. í‹€ë¦° ì´ìœ ëŠ” 1ë¬¸ë‹¨ì— ë‚˜ì˜¨ ë¶€í’ˆì˜ ì´ë¦„ê³¼ ì—­í• ì„ ê¸°ì–µí•˜ì§€ ëª»í•œ ì±„, 3ë¬¸ë‹¨ì˜ ë³µì¡í•œ ì‘ë™ ê³¼ì •ì„ ì½ìœ¼ë ¤ í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì •ë³´ëŸ‰ì´ ìŸì•„ì§ˆ ë•Œ 'êµí†µì •ë¦¬'ë¥¼ ì‹¤íŒ¨í•œ ê²ƒì…ë‹ˆë‹¤.

**2. ë…í•´ ì „ëµ (Reading Strategy)**
* **êµ¬ì„± ìš”ì†Œ íŒŒì•…:** 'Aì¥ì¹˜ëŠ” a, b, cë¡œ êµ¬ì„±ëœë‹¤'ë¼ëŠ” ë¬¸ì¥ì´ ë‚˜ì˜¤ë©´ a, b, cì— ê°ê° ë²ˆí˜¸(â‘ , â‘¡, â‘¢)ë¥¼ ë§¤ê¸°ê³  ë™ê·¸ë¼ë¯¸ ì¹˜ì„¸ìš”.
* **ìˆœì„œ ì²´í¬:** 'ë¨¼ì €', 'ê·¸ í›„', 'ë§ˆì§€ë§‰ìœ¼ë¡œ' ê°™ì€ ìˆœì„œ í‘œì§€ì— ë¯¼ê°í•´ì•¼ í•©ë‹ˆë‹¤. ê³¼ì •ì´ ë°”ë€ŒëŠ” ì§€ì ì„ ëŠì–´ ì½ìœ¼ì„¸ìš”.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **ê·¸ë¦¼ ê·¸ë¦¬ê¸°:** ì§€ë¬¸ ì˜† ì—¬ë°±ì— ì¥ì¹˜ì˜ êµ¬ì¡°ë¥¼ ê°„ë‹¨í•œ ê·¸ë¦¼ì´ë‚˜ ëª¨í˜•ìœ¼ë¡œ ê·¸ë ¤ë³´ì„¸ìš”.
2.  **ê³¼ì • ë²ˆí˜¸ ë§¤ê¸°ê¸°:** ì‘ë™ ì›ë¦¬ê°€ ì„¤ëª…ëœ ë¬¸ë‹¨ì—ëŠ” ë¬¸ì¥ë§ˆë‹¤ â‘ , â‘¡, â‘¢ ë²ˆí˜¸ë¥¼ ë§¤ê²¨ì„œ í”„ë¡œì„¸ìŠ¤ë¥¼ ë¶„í• í•˜ì„¸ìš”.
3.  **ì¸ê³¼ì„± í™•ì¸:** 'Aê°€ Bë¥¼ ëˆ„ë¥´ë©´ Cê°€ ì—´ë¦°ë‹¤'ì²˜ëŸ¼ ë¶€í’ˆ ê°„ì˜ ìƒí˜¸ì‘ìš©(ì¸ê³¼)ì„ í™”ì‚´í‘œë¡œ ì—°ê²°í•˜ë©° ì½ëŠ” ì—°ìŠµì„ í•˜ì„¸ìš”.
"""

    # =================================================================
    # [3] ë¬¸í•™ (ì†Œì„¤, ì‹œê°€)
    # =================================================================
    elif "ì†Œì„¤" in question_type or "ê°ë³¸" in question_type or "ì„œì‚¬" in question_type:
        return """
### ğŸ­ [ì‹¬ì¸µ ë¶„ì„] ë¬¸í•™(ì‚°ë¬¸): ì¸ë¬¼ ê´€ê³„ë„ì™€ ê°ˆë“±ì„ ì¡ìœ¼ì„¸ìš”.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ì†Œì„¤ì€ 'ì´ì•¼ê¸°'ì…ë‹ˆë‹¤. ë‚´ìš©ì„ í‹€ë ¸ë‹¤ëŠ” ê±´ **ëˆ„ê°€, ëˆ„êµ¬ì—ê²Œ, ì™œ í™”ë¥¼ ë‚´ëŠ”ì§€(ê°ˆë“±)** ê·¸ ë§¥ë½ì„ ë†“ì³¤ë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤. ì§€ì—½ì ì¸ ë¬¸ì¥ì— ì§‘ì°©í•˜ë‹¤ê°€ ì „ì²´ ì¤„ê±°ë¦¬ì˜ íë¦„ì„ ë†“ì¹œ ê²½ìš°ì…ë‹ˆë‹¤.

**2. ë…í•´ ì „ëµ (Reading Strategy)**
* **ì¸ë¬¼ í‘œì‹œ:** ê¸ì •ì /ì•„êµ° ì¸ë¬¼ì—ëŠ” `O`, ë¶€ì •ì /ì êµ° ì¸ë¬¼ì—ëŠ” `X` ë˜ëŠ” `ì„¸ëª¨` í‘œì‹œë¥¼ í•˜ë©° ì½ìœ¼ì„¸ìš”.
* **ì‹¬ë¦¬/íƒœë„ ë°‘ì¤„:** ì¸ë¬¼ì˜ ê¸°ë¶„ì„ ë‚˜íƒ€ë‚´ëŠ” í˜•ìš©ì‚¬ë‚˜ ë¶€ì‚¬, ëŒ€ì‚¬ì—ëŠ” ë¬¼ê²° ë°‘ì¤„(`~~~~`)ì„ ê·¸ìœ¼ì„¸ìš”. ê·¸ê²Œ ê³§ ë¬¸ì œì˜ ì •ë‹µ ê·¼ê±°ì…ë‹ˆë‹¤.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **ì¸ë¬¼ ê´€ê³„ë„:** ì§€ë¬¸ì„ ë‹¤ ì½ê³  ì¤‘ì‹¬ ì¸ë¬¼ë“¤ì„ ì ì€ ë’¤, ì„œë¡œ ì¢‹ì•„í•˜ëŠ”ì§€(í™”ì‚´í‘œ), ì‹«ì–´í•˜ëŠ”ì§€(ë²ˆê°œí‘œì‹œ âš¡) ê´€ê³„ë„ë¥¼ ê·¸ë ¤ë³´ì„¸ìš”.
2.  **ì¥ë©´ ëŠê¸°:** ì†Œì„¤ì€ 'ì¤‘ëµ'ì´ë‚˜ ì¥ì†Œê°€ ë°”ë€ŒëŠ” ë¶€ë¶„ì—ì„œ ì¥ë©´ì´ ì „í™˜ë©ë‹ˆë‹¤. ì¥ë©´ë³„ë¡œ 'ëˆ„ê°€', 'ë¬´ì—‡ì„ í–ˆë‚˜'ë¥¼ í•œ ì¤„ë¡œ ìš”ì•½í•˜ì„¸ìš”.
3.  **ì„œìˆ ì ì°¾ê¸°:** 'ë‚˜'ê°€ ë‚˜ì˜¤ë©´ 1ì¸ì¹­, ì•ˆ ë‚˜ì˜¤ë©´ 3ì¸ì¹­ì…ë‹ˆë‹¤. ì„œìˆ ìê°€ ì¸ë¬¼ì˜ ì†ë§ˆìŒê¹Œì§€ ë‹¤ ì•„ëŠ”ì§€(ì „ì§€ì ), ê´€ì°°ë§Œ í•˜ëŠ”ì§€ ì²´í¬í•˜ì„¸ìš”.
"""

    elif "ì‹œê°€" in question_type or "ì‹œì–´" in question_type or "ì‘í’ˆ" in question_type:
        return """
### ğŸŒ™ [ì‹¬ì¸µ ë¶„ì„] ë¬¸í•™(ìš´ë¬¸): í™”ìì˜ 'ìƒí™©'ê³¼ 'ì •ì„œ'ë§Œ ì°¾ìœ¼ì„¸ìš”.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ì‹œë¥¼ ë„ˆë¬´ ì‹¬ì˜¤í•˜ê²Œ í•´ì„í•˜ë ¤ í–ˆê±°ë‚˜, ìì‹ ì˜ ì£¼ê´€ì ì¸ ê°ì •ìœ¼ë¡œ ì½ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ìˆ˜ëŠ¥ ì‹œ ë¬¸í•™ì€ 'ìˆ¨ì€ ì˜ë¯¸ ì°¾ê¸°'ê°€ ì•„ë‹ˆë¼, í…ìŠ¤íŠ¸ì— ë“œëŸ¬ë‚œ **ê°ê´€ì ì¸ ìƒí™© ì •ë³´**ë¥¼ ì°¾ëŠ” ê²Œì„ì…ë‹ˆë‹¤.

**2. ë…í•´ ì „ëµ (Reading Strategy)**
* **ì£¼ì–´ ì°¾ê¸°:** ëˆ„ê°€(í™”ìê°€) ë¬´ì—‡ì„ ë³´ê³  ìˆëŠ”ì§€ ì°¾ìœ¼ì„¸ìš”.
* **ìƒí™© íŒŒì•…:** ì´ë³„ ì¤‘ì¸ì§€, ìì—° ì†ì— ìˆëŠ”ì§€, ê°€ë‚œí•œ ìƒí™©ì¸ì§€ íŒ©íŠ¸ë§Œ ì²´í¬í•˜ì„¸ìš”.
* **ì •ì„œ/íƒœë„:** ê·¸ë˜ì„œ ìŠ¬í”ˆê°€? ê¸°ìœê°€? ì˜ì§€ì ì¸ê°€? ì²´ë…ì ì¸ê°€? ì‹œì–´ ë’¤ì— ìˆ¨ì€ ì„œìˆ ì–´ì—ì„œ íŒíŠ¸ë¥¼ ì–»ìœ¼ì„¸ìš”.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **í˜•ê´‘íœ ì¹ í•˜ê¸°:** ì‹œë¥¼ ì½ìœ¼ë©° ê°ì •ì„ ë‚˜íƒ€ë‚´ëŠ” ë‹¨ì–´(ìŠ¬í””, ëˆˆë¬¼, ì™¸ë¡œì›€, ì¦ê±°ì›€ ë“±)ì—ë§Œ í˜•ê´‘íœì„ ì¹ í•´ ë³´ì„¸ìš”. ê·¸ê²ƒë§Œ ì—°ê²°í•´ë„ ì£¼ì œê°€ ë‚˜ì˜µë‹ˆë‹¤.
2.  **ì‹œì–´ì˜ ê¸°í˜¸í™”:** ê¸ì •ì ì¸ ì‹œì–´(ìƒëª…, ì‚¬ë‘, í¬ë§)ëŠ” `(+)`, ë¶€ì •ì ì¸ ì‹œì–´(ì£½ìŒ, ì´ë³„, ì‹œë ¨)ëŠ” `(-)`ë¡œ í‘œì‹œí•˜ë©° ì½ëŠ” í›ˆë ¨ì„ í•˜ì„¸ìš”.
3.  **ë³´ê¸° ë¨¼ì € ì½ê¸°:** <ë³´ê¸°>ê°€ ìˆëŠ” ë¬¸ì œëŠ” ë¬´ì¡°ê±´ <ë³´ê¸°>ë¥¼ ë¨¼ì € ì½ì–´ì•¼ í•©ë‹ˆë‹¤. <ë³´ê¸°>ëŠ” í•´ì„ì˜ ê¸°ì¤€(ì•ˆê²½)ì„ ì œê³µí•´ ì¤ë‹ˆë‹¤.
"""

    # =================================================================
    # [4] ê³ ë‚œë„ ì‘ìš© (ë³´ê¸°, ì ìš©)
    # =================================================================
    elif "ì ìš©" in question_type or "ë³´ê¸°" in question_type:
        return """
### ğŸ”¥ [ì‹¬ì¸µ ë¶„ì„] ê³ ë‚œë„: <ë³´ê¸°>ëŠ” ë˜ í•˜ë‚˜ì˜ ì§€ë¬¸ì…ë‹ˆë‹¤.

**1. ì§„ë‹¨: ì™œ í‹€ë ¸ì„ê¹Œìš”?**
ì´ ìœ í˜•ì€ êµ­ì–´ ì‹œí—˜ì˜ 'ë³´ìŠ¤ ëª¬ìŠ¤í„°'ì…ë‹ˆë‹¤. í‹€ë¦° ì´ìœ ëŠ” ì§€ë¬¸ì˜ ë‚´ìš©ë„ ì•Œê³  <ë³´ê¸°>ë„ ì½ì—ˆì§€ë§Œ, **ì´ ë‘˜ì„ ì—°ê²°(Mapping)**í•˜ì§€ ëª»í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë”°ë¡œë”°ë¡œ ìƒê°í•˜ë©´ ì ˆëŒ€ í’€ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.

**2. ë¬¸ì œ í•´ê²° ì•Œê³ ë¦¬ì¦˜**
1.  **ì§€ë¬¸(ì¼ë°˜ë¡ ):** ì§€ë¬¸ì—ì„œ ì„¤ëª…í•˜ëŠ” í•µì‹¬ ì›ë¦¬ë‚˜ ê³µì‹ì„ ë¨¼ì € ì™„ë²½íˆ ì´í•´í•©ë‹ˆë‹¤.
2.  **ë³´ê¸°(êµ¬ì²´ì  ì‚¬ë¡€):** <ë³´ê¸°>ì— ë‚˜ì˜¨ ì‚¬ë¡€ê°€ ì§€ë¬¸ì˜ ì–´ë–¤ ê°œë…ì— í•´ë‹¹í•˜ëŠ”ì§€ ì¼ëŒ€ì¼ë¡œ ë§¤ì¹­í•©ë‹ˆë‹¤. (ì˜ˆ: ì§€ë¬¸ì˜ 'ìˆ˜ìš”' = ë³´ê¸°ì˜ 'ì•„ì´ìŠ¤í¬ë¦¼ êµ¬ë§¤ëŸ‰')
3.  **ì„ ì§€ íŒë‹¨:** ì„ ì§€ì˜ ë‚´ìš©ì´ ì§€ë¬¸ì˜ ì›ë¦¬ì— ìœ„ë°°ë˜ëŠ”ì§€, í˜¹ì€ <ë³´ê¸°>ì˜ ìƒí™©ê³¼ ë§ì§€ ì•ŠëŠ”ì§€ ë…¼ë¦¬ì  ëª¨ìˆœì„ ì°¾ìŠµë‹ˆë‹¤.

**3. êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ (Action Plan)**
1.  **ë§¤ì¹­ ì—°ìŠµ:** ë¬¸ì œë¥¼ í’€ ë•Œ, ì„ ì§€ì˜ ë‹¨ì–´ê°€ ì§€ë¬¸ì˜ ëª‡ ë²ˆì§¸ ë¬¸ë‹¨ì—ì„œ ì™”ëŠ”ì§€, <ë³´ê¸°>ì˜ ì–´ë–¤ ë‹¨ì–´ì™€ ì—°ê²°ë˜ëŠ”ì§€ í™”ì‚´í‘œë¥¼ ê¸‹ëŠ” ì—°ìŠµì„ í•˜ì„¸ìš”.
2.  **ì„ ì§€ ëŠì–´ ì½ê¸°:** 3ì ì§œë¦¬ ë³´ê¸° ë¬¸ì œì˜ ì„ ì§€ëŠ” ê¹ë‹ˆë‹¤. `~í•´ì„œ(ê·¼ê±°)` / `~í•˜ë‹¤(íŒë‹¨)`ë¡œ ì‚¬ì„ ì„ ê·¸ì–´ ëŠìœ¼ì„¸ìš”. ì•ë¶€ë¶„ ê·¼ê±°ê°€ í‹€ë ¸ëŠ”ì§€ ë’·ë¶€ë¶„ íŒë‹¨ì´ í‹€ë ¸ëŠ”ì§€ ìª¼ê°œì„œ ë´ì•¼ ë³´ì…ë‹ˆë‹¤.
3.  **ê¸°ì¶œ ë¶„ì„:** ë§ì€ ë¬¸ì œë¼ë„ í•´ì„¤ì§€ë¥¼ ë³´ë©° 'ì¶œì œìê°€ ì§€ë¬¸ì˜ Aê°œë…ì„ ë³´ê¸°ì˜ Bìƒí™©ìœ¼ë¡œ ì–´ë–»ê²Œ ë³€í˜•í–ˆëŠ”ì§€' ê·¸ ì¶œì œ íŒ¨í„´ì„ ë¶„ì„í•˜ì„¸ìš”.
"""
    
    else:
        return """
### âš ï¸ [ì¢…í•© ì§„ë‹¨] ê¸°ì´ˆ ì²´ë ¥ì„ ê¸¸ëŸ¬ì•¼ í•  ë•Œì…ë‹ˆë‹¤.

**1. ì§„ë‹¨**
í•´ë‹¹ ìœ í˜•ì€ êµ­ì–´ ì˜ì—­ì˜ ê°€ì¥ ê¸°ì´ˆì ì¸ ë…í•´ë ¥ì´ë‚˜ ì–´íœ˜ë ¥ì´ ë¶€ì¡±í•˜ì—¬ ë°œìƒí•œ ì˜¤ë‹µì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜¹ì€ ë¬¸ì œë¥¼ ë„ˆë¬´ ê¸‰í•˜ê²Œ í’€ë‹¤ê°€ ì‹¤ìˆ˜ë¥¼ í–ˆì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

**2. ì²˜ë°©ì „**
* **ì–´íœ˜ë ¥ ì ê²€:** ì„ ì§€ë‚˜ ì§€ë¬¸ì— ëª¨ë¥´ëŠ” ë‹¨ì–´ê°€ 3ê°œ ì´ìƒ ìˆì—ˆë‹¤ë©´, ë‹¨ì–´ì¥ ì •ë¦¬ê°€ ìµœìš°ì„ ì…ë‹ˆë‹¤.
* **í•´ì„¤ì§€ ì •ë…:** ì •ë‹µì´ ì™œ ì •ë‹µì¸ì§€ ì•„ëŠ” ê²ƒë³´ë‹¤, **ë‚´ê°€ ê³ ë¥¸ ì˜¤ë‹µì´ ì™œ ë‹µì´ ë  ìˆ˜ ì—†ëŠ”ì§€**ë¥¼ ë‚¨ì—ê²Œ ì„¤ëª…í•  ìˆ˜ ìˆì„ ì •ë„ë¡œ ë¶„ì„í•˜ì„¸ìš”.
* **ì‹œê°„ ê´€ë¦¬:** ë¬¸ì œë¥¼ í‘¸ëŠ” ì†ë„ë³´ë‹¤ **ì •í™•ë„**ê°€ ë¨¼ì €ì…ë‹ˆë‹¤. ì²œì²œíˆ ì½ë”ë¼ë„ í•œ ë²ˆì— ì •í™•í•˜ê²Œ ì½ëŠ” ì—°ìŠµì„ í•˜ì„¸ìš”.
"""
def get_strength_message(question_type):
    if "ë¬¸ë²•" in question_type:
        return "ğŸ’ **[ë¬¸ë²• ë§ˆìŠ¤í„°]** ë¬¸ë²• ê°œë…ì´ ì•„ì£¼ íƒ„íƒ„í•˜ê²Œ ì¡í˜€ìˆë„¤ìš”! ë…¼ë¦¬ì ì¸ ì ‘ê·¼ì´ ë‹ë³´ì…ë‹ˆë‹¤."
    elif "ë¹„ë¬¸í•™" in question_type:
        return "ğŸ§  **[ë…¼ë¦¬ì™•]** ì •ë³´ëŸ‰ì´ ë§ì€ ë¹„ë¬¸í•™ ì§€ë¬¸ì„ êµ¬ì¡°ì ìœ¼ë¡œ ë…í•´í•˜ëŠ” ëŠ¥ë ¥ì´ íƒì›”í•©ë‹ˆë‹¤!"
    elif "ë¬¸í•™" in question_type:
        return "ğŸ’– **[ê³µê° ëŠ¥ë ¥ì]** ì‘í’ˆ ì† ì¸ë¬¼ì˜ ì‹¬ë¦¬ì™€ ì‘ê°€ì˜ ì˜ë„ë¥¼ ê¿°ëš«ì–´ ë³´ëŠ” ê°ìˆ˜ì„±ì´ ë›°ì–´ë‚©ë‹ˆë‹¤!"
    elif "ë³´ê¸°" in question_type:
        return "ğŸš€ **[ì‘ìš© ì²œì¬]** ë‚¨ë“¤ì´ ê°€ì¥ ì–´ë ¤ì›Œí•˜ëŠ” <ë³´ê¸°> ì‘ìš© ë¬¸ì œë¥¼ ì™„ë²½í•˜ê²Œ í•´ê²°í–ˆë„¤ìš”."
    else:
        return "âœ¨ **[ì„±ì‹¤í•œ í•™ìŠµì]** í•´ë‹¹ ìœ í˜•ì— ëŒ€í•œ ì´í•´ë„ê°€ ì™„ë²½í•©ë‹ˆë‹¤."

# --- 4. ë©”ì¸ í™”ë©´ (UI) ---
st.set_page_config(page_title="êµ­ì–´ ëª¨ì˜ê³ ì‚¬ ì±„ì ", page_icon="ğŸ“")
st.title("ğŸ“ êµ­ì–´ ëª¨ì˜ê³ ì‚¬ ìë™ ì±„ì  & ë¶„ì„")

tab1, tab2 = st.tabs(["ë‹µì•ˆ ì œì¶œí•˜ê¸°", "ë‚´ ë“±ìˆ˜ ì¡°íšŒí•˜ê¸°"])

# === [íƒ­ 1] ë‹µì•ˆ ì…ë ¥ ë° ì±„ì  ===
with tab1:
    st.write("##### í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ë‹µì•ˆì„ ì²´í¬í•˜ì„¸ìš”.")
    with st.form("exam_form"):
        c1, c2 = st.columns(2)
        name = c1.text_input("ì´ë¦„", placeholder="í™ê¸¸ë™")
        student_id = c2.text_input("í•™ë²ˆ (ë˜ëŠ” ID)", placeholder="ì˜ˆ: 10101")
        
        st.markdown("---")
        user_answers = {}
        cols = st.columns(4)
        for q_num in EXAM_DATA.keys():
            col_idx = (q_num - 1) % 4
            with cols[col_idx]:
                user_answers[q_num] = st.number_input(
                    f"{q_num}ë²ˆ ({EXAM_DATA[q_num]['score']}ì )", 
                    min_value=1, max_value=5, step=1, key=f"q_{q_num}"
                )

        submit = st.form_submit_button("ì±„ì  ì œì¶œí•˜ê¸°", use_container_width=True)

    if submit:
        if not name or not student_id:
            st.error("ì´ë¦„ê³¼ í•™ë²ˆì„ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”!")
        else:
            total_score = 0
            wrong_list = []
            wrong_q_nums = []
            
            for q, info in EXAM_DATA.items():
                if user_answers[q] == info['ans']:
                    total_score += info['score']
                else:
                    wrong_list.append(info['type'])
                    wrong_q_nums.append(str(q))
            
            sheet = get_google_sheet_data()
            if sheet:
                try:
                    records = sheet.get_all_records()
                    wrong_q_str = ", ".join(wrong_q_nums) if wrong_q_nums else "ì—†ìŒ"
                    
                    new_row = [
                        student_id, name, total_score, 
                        " | ".join(wrong_list), 
                        datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        wrong_q_str
                    ]
                    sheet.append_row(new_row)
                    
                    records = sheet.get_all_records()
                    df = pd.DataFrame(records)
                    my_rank = df[df['Score'] > total_score].shape[0] + 1
                    total_students = len(df)
                    percentile = (my_rank / total_students) * 100
                    
                    # ê²°ê³¼ ì¶œë ¥
                    st.divider()
                    st.subheader(f"ğŸ“¢ {name}ë‹˜ì˜ ë¶„ì„ ê²°ê³¼")
                    
                    c1, c2, c3 = st.columns(3)
                    c1.metric("ë‚´ ì ìˆ˜", f"{int(total_score)}ì ")
                    c2.metric("í˜„ì¬ ë“±ìˆ˜", f"{my_rank}ë“±", f"/ {total_students}ëª…")
                    c3.metric("ìƒìœ„", f"{percentile:.1f}%")
                    
                    st.markdown("---")
                    
                    if wrong_q_nums:
                        st.error(f"âŒ **í‹€ë¦° ë¬¸ì œ ë²ˆí˜¸:** {', '.join(wrong_q_nums)}ë²ˆ")
                    else:
                        st.success("â­• **í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!**")

                    # ê°•ì  ë¶„ì„
                    st.success("ğŸŒŸ **ë‚˜ì˜ ê°•ì  ë°œê²¬!**")
                    found_any_strength = False
                    
                    grammar_keys = ["ë¬¸ë²•", "ìŒìš´", "êµ­ì–´ì‚¬ì „", "ì¤‘ì„¸"]
                    is_grammar_wrong = any(any(k in w_type for k in grammar_keys) for w_type in wrong_list)
                    has_grammar_q = any(any(k in info['type'] for k in grammar_keys) for info in EXAM_DATA.values())
                    if has_grammar_q and not is_grammar_wrong:
                        st.write(f"- {get_strength_message('ë¬¸ë²•')}")
                        found_any_strength = True

                    nonlit_keys = ["ë¹„ë¬¸í•™", "ì² í•™", "ê²½ì œ", "ê±´ì¶•", "ê¸°ìˆ ", "ê³¼í•™", "ì¸ë¬¸", "ì‚¬íšŒ"]
                    is_nonlit_wrong = any(any(k in w_type for k in nonlit_keys) for w_type in wrong_list)
                    has_nonlit_q = any(any(k in info['type'] for k in nonlit_keys) for info in EXAM_DATA.values())
                    if has_nonlit_q and not is_nonlit_wrong:
                        st.write(f"- {get_strength_message('ë¹„ë¬¸í•™')}")
                        found_any_strength = True

                    lit_keys = ["ì‹œê°€", "ì‘í’ˆ", "ì‹œì–´", "ì†Œì„¤", "ê°ë³¸", "ì„œì‚¬"]
                    is_lit_wrong = any(any(k in w_type for k in lit_keys) for w_type in wrong_list)
                    has_lit_q = any(any(k in info['type'] for k in lit_keys) for info in EXAM_DATA.values())
                    if has_lit_q and not is_lit_wrong:
                        st.write(f"- {get_strength_message('ë¬¸í•™')}")
                        found_any_strength = True

                    hard_keys = ["ì ìš©", "ë³´ê¸°", "ì¤€ê±°"]
                    is_hard_wrong = any(any(k in w_type for k in hard_keys) for w_type in wrong_list)
                    has_hard_q = any(any(k in info['type'] for k in hard_keys) for info in EXAM_DATA.values())
                    if has_hard_q and not is_hard_wrong:
                        st.write(f"- {get_strength_message('ë³´ê¸°')}")
                        found_any_strength = True

                    if not found_any_strength:
                        st.write("- ëª¨ë“  ì˜ì—­ì—ì„œ ì¡°ê¸ˆì”© ì‹¤ìˆ˜ê°€ ìˆì—ˆë„¤ìš”. ë‹¤ìŒì—” ë§Œì ì…ë‹ˆë‹¤! ğŸ’ª")

                    # ì•½ì  ë¶„ì„ ë° ì„±ì í‘œ ìƒì„±
                    final_feedback_html = ""
                    if wrong_list:
                        st.markdown("---")
                        st.error(f"ğŸš¨ **ë³´ì™„ì´ í•„ìš”í•œ ë¶€ë¶„ ({len(wrong_list)}ë¬¸ì œ ì˜¤ë‹µ)**")
                        unique_feedback = set(get_feedback_message(w) for w in wrong_list)
                        for msg in unique_feedback:
                            st.markdown(msg)
                            st.markdown("---")
                            clean_msg = msg.replace("###", "<h3>").replace("**", "<b>").replace("\n", "<br>")
                            final_feedback_html += f"<div class='feedback-box'>{clean_msg}</div>"
                    else:
                        st.balloons()
                        st.write("### ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤! ì•½ì ì´ ì—†ëŠ” ë¬´ê²°ì  ì‹¤ë ¥ì…ë‹ˆë‹¤!")
                        final_feedback_html = "<div class='feedback-box'><h3>ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤!</h3>í‹€ë¦° ë¬¸ì œê°€ ì—†ì–´ í•™ìŠµ ì²˜ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>"

                    st.write("### ğŸ’¾ ê²°ê³¼ ì €ì¥")
                    report_html = create_report_html(
                        name, total_score, my_rank, total_students, wrong_q_nums, wrong_list, final_feedback_html
                    )
                    
                    st.download_button(
                        label="ğŸ“¥ ì„±ì í‘œ ë‹¤ìš´ë¡œë“œ (PDF ì €ì¥ìš©)",
                        data=report_html,
                        file_name=f"{name}_êµ­ì–´ì„±ì í‘œ.html",
                        mime="text/html"
                    )

                except Exception as e: # <--- ì—¬ê¸°ê°€ ë°”ë¡œ ì•„ê¹Œ ì‚¬ë¼ì¡Œë˜ ê·¸ ë¶€ë¶„ì…ë‹ˆë‹¤!
                    st.error(f"ë°ì´í„° ì €ì¥ ì˜¤ë¥˜: {e}")

# === [íƒ­ 2] ë“±ìˆ˜ ì¬ì¡°íšŒ ===
with tab2:
    st.header("ğŸ” ë‚´ ë“±ìˆ˜ & í‹€ë¦° ë¬¸ì œ í™•ì¸")
    check_id = st.text_input("í•™ë²ˆ(ID) ì…ë ¥", key="check_input")
    
    if st.button("ì¡°íšŒí•˜ê¸°"):
        sheet = get_google_sheet_data()
        if sheet:
            try:
                records = sheet.get_all_records()
                df = pd.DataFrame(records)
                df['ID'] = df['ID'].astype(str) 
                user_record = df[df['ID'] == check_id]
                
                if not user_record.empty:
                    last_row = user_record.iloc[-1]
                    current_score = last_row['Score']
                    
                    wrong_q_print = "ì—†ìŒ"
                    if 'Wrong_Questions' in df.columns:
                        val = last_row['Wrong_Questions']
                        if pd.notna(val) and str(val).strip() != "":
                            wrong_q_print = str(val)
                    
                    wrong_types_str = str(last_row.get('Wrong_Types', ''))
                    wrong_list = wrong_types_str.split(" | ") if wrong_types_str.strip() else []

                    realtime_rank = df[df['Score'] > current_score].shape[0] + 1
                    total_now = len(df)
                    top_pct = (realtime_rank / total_now) * 100
                    
                    st.success(f"ë°˜ê°‘ìŠµë‹ˆë‹¤, **{last_row['Name']}**ë‹˜!")
                    m1, m2, m3 = st.columns(3)
                    m1.metric("ë‚´ ì ìˆ˜", f"{int(current_score)}ì ")
                    m2.metric("í˜„ì¬ ë“±ìˆ˜", f"{realtime_rank}ë“± / {total_now}ëª…")
                    m3.metric("ìƒìœ„", f"{top_pct:.1f}%")
                    st.markdown("---")
                    
                    if wrong_q_print and wrong_q_print != "ì—†ìŒ":
                        st.error(f"âŒ **í‹€ë¦° ë¬¸ì œ ë²ˆí˜¸:** {wrong_q_print}ë²ˆ")
                    else:
                        st.success("â­• **í‹€ë¦° ë¬¸ì œê°€ ì—†ê±°ë‚˜, ì´ì „ ê¸°ë¡ì´ë¼ ë²ˆí˜¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.**")

                    # ê°•ì  ë¶„ì„ (ì¬ì‚¬ìš©)
                    st.info("ğŸŒŸ **ë‚˜ì˜ ê°•ì  ë‹¤ì‹œ ë³´ê¸°**")
                    found_any_strength = False
                    grammar_keys = ["ë¬¸ë²•", "ìŒìš´", "êµ­ì–´ì‚¬ì „", "ì¤‘ì„¸"]
                    is_grammar_wrong = any(any(k in w_type for k in grammar_keys) for w_type in wrong_list)
                    has_grammar_q = any(any(k in info['type'] for k in grammar_keys) for info in EXAM_DATA.values())
                    if has_grammar_q and not is_grammar_wrong:
                        st.write(f"- {get_strength_message('ë¬¸ë²•')}")
                        found_any_strength = True

                    nonlit_keys = ["ë¹„ë¬¸í•™", "ì² í•™", "ê²½ì œ", "ê±´ì¶•", "ê¸°ìˆ ", "ê³¼í•™", "ì¸ë¬¸", "ì‚¬íšŒ"]
                    is_nonlit_wrong = any(any(k in w_type for k in nonlit_keys) for w_type in wrong_list)
                    has_nonlit_q = any(any(k in info['type'] for k in nonlit_keys) for info in EXAM_DATA.values())
                    if has_nonlit_q and not is_nonlit_wrong:
                        st.write(f"- {get_strength_message('ë¹„ë¬¸í•™')}")
                        found_any_strength = True

                    lit_keys = ["ì‹œê°€", "ì‘í’ˆ", "ì‹œì–´", "ì†Œì„¤", "ê°ë³¸", "ì„œì‚¬"]
                    is_lit_wrong = any(any(k in w_type for k in lit_keys) for w_type in wrong_list)
                    has_lit_q = any(any(k in info['type'] for k in lit_keys) for info in EXAM_DATA.values())
                    if has_lit_q and not is_lit_wrong:
                        st.write(f"- {get_strength_message('ë¬¸í•™')}")
                        found_any_strength = True

                    hard_keys = ["ì ìš©", "ë³´ê¸°", "ì¤€ê±°"]
                    is_hard_wrong = any(any(k in w_type for k in hard_keys) for w_type in wrong_list)
                    has_hard_q = any(any(k in info['type'] for k in hard_keys) for info in EXAM_DATA.values())
                    if has_hard_q and not is_hard_wrong:
                        st.write(f"- {get_strength_message('ë³´ê¸°')}")
                        found_any_strength = True

                    if not found_any_strength:
                        st.write("- ëª¨ë“  ì˜ì—­ì—ì„œ ì¡°ê¸ˆì”© ì‹¤ìˆ˜ê°€ ìˆì—ˆë„¤ìš”. í™”ì´íŒ…!")

                    # ì•½ì  ë¶„ì„ (ì¬ì‚¬ìš©)
                    final_feedback_html = ""
                    if wrong_list:
                        st.markdown("---")
                        st.error("ğŸš¨ **ë³´ì™„ì´ í•„ìš”í•œ ë¶€ë¶„ ë‹¤ì‹œ ë³´ê¸°**")
                        unique_feedback = set(get_feedback_message(w) for w in wrong_list)
                        for msg in unique_feedback:
                            st.markdown(msg)
                            st.markdown("---")
                            clean_msg = msg.replace("###", "<h3>").replace("**", "<b>").replace("\n", "<br>")
                            final_feedback_html += f"<div class='feedback-box'>{clean_msg}</div>"
                    else:
                        final_feedback_html = "<div class='feedback-box'><h3>ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤!</h3>ì˜¤ë‹µ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>"

                    st.markdown("---")
                    st.write("### ğŸ’¾ ì„±ì í‘œ ë‹¤ì‹œ ì €ì¥í•˜ê¸°")
                    
                    if wrong_q_print and wrong_q_print != "ì—†ìŒ":
                        w_nums = wrong_q_print.split(", ")
                    else:
                        w_nums = []

                    report_html = create_report_html(
                        last_row['Name'], current_score, realtime_rank, total_now, w_nums, wrong_list, final_feedback_html
                    )
                    
                    st.download_button(
                        label="ğŸ“¥ ì„±ì í‘œ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ",
                        data=report_html,
                        file_name=f"{last_row['Name']}_êµ­ì–´ì„±ì í‘œ_ì¬ë°œê¸‰.html",
                        mime="text/html"
                    )

                else:
                    st.warning("í•´ë‹¹ í•™ë²ˆì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
            except Exception as e:
                st.error(f"ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
